control 'cve-scan' do
  impact 0.5
  title 'CVE vulnerabilities - all packages must be up to date on security
    patches'
  desc 'Foundational security requires all system components to be free of
  well-known, patchable vulnerabilities as documented on cve.mitre.org.'
  tag "nist": ["SI-2", "RA-5", "Rev_4"]
  tag "check": "Run the command “yum updateinfo list cves” to list all packages
  that have known cve.mitre.org patchable vulnerabilities"
  tag "fix": "Run the command “yum update -y” to ensure the packages are up to
  date on patches."

  yum_exist_status = command('yum repolist').exit_status
  cve_list = command('yum updateinfo list cves')

  describe 'CVE vulnerabilities' do
    subject { cve_list }
    its('stdout.strip') { should_not match /(CVE-\d{4}-\d{4,7})/ }
  end if yum_exist_status.eql?(0) && cve_list.exit_status.eql?(0)

  describe 'This control must be reviewed manually' do
    skip 'The `yum` command failed.
    Please verify that `yum` is configured correctly on the target system.
    This control must be reviewed manually'
  end if !yum_exist_status.eql?(0) || !cve_list.exit_status.eql?(0)
end
